# 计划任务

计划任务可以按照设置的规律执行所需的代码。

## 安装

```
composer require wind-framework/crontab
```

## 配置

使用时请先确认有计划任务的配置文件 `config/crontab.php`:

```php
<?php
/*
Crontab config example

Rule:
*    *    *    *    *
-    -    -    -    -
|    |    |    |    |
|    |    |    |    |
|    |    |    |    +----- day of week (0 - 7) (Sunday=0 or 7)
|    |    |    +---------- month (1 - 12)
|    |    +--------------- day of month (1 - 31)
|    +-------------------- hour (0 - 23)
+------------------------- min (0 - 59)
*/
return [
    'ClearTempFiles' => [
        'enable' => true,
        'rule' => '0 * * * *',
        'command' => 'maintain:clear-temp-files',
        'desc' => '清理临时文件'
    ]
];
```

### 配置项详解

配置是一个二维数组，数组的索引是一个帮助记忆的名称，你也可以不写该索引，让 PHP 自己生成数字索引。

配置中的各字段含义如下：

字段名 | 必须 | 介绍
-- | -- | --
enable | 是 | 是否启用
rule | 是 | crontab 规则，详见下面 Crontab 规则介绍
command | 在未配置 execute 时必须 | 定时任务要执行的命令
execute | 在未配置 command 时必须 | 定时任务要执行的 callable，可以是一个函数，或者指向一个类的方法
desc | 是 | 任务的描述

### Crontab 规则

配置中的 `rule` 是参照 Linux 上的 crontab 所设计，在使用时需要先了解 crontab 的规则，配置总共有 5 个时间点，用空格隔开，每个时间点含义如下所示。

```
*    *    *    *    *
-    -    -    -    -
|    |    |    |    |
|    |    |    |    |
|    |    |    |    +----- 星期中的某一天 (0 - 7) (周日=0 或 7)
|    |    |    +---------- 月 (1 - 12)
|    |    +--------------- 该月第几天 (1 - 31)
|    +-------------------- 小时 (0 - 23)
+------------------------- 分钟 (0 - 59)
```

根据规则定义所在时间点的规则，规则有多种配置方式：

规则 | 意思 | 描述
-- | -- | --
\* | 每次 | 如每分钟，每小时
2 | 具体的时间点 | 如 2 在分钟上代表 2 分，在小时则是 2 点
\*/2 | 每隔多久 | 如 2/\* 在分钟上代表每隔 2 分钟，在天上代表每隔 2 天
2-5 | 连续的数字 | 如 2-5 在分钟上代表第 2,3,4,5 分钟，在小时代表怎么 2,3,4,5 小时
1,2,7 | 多个具体的时间 | 如 1,2,7 在小时上代表第 1 点，2 点，7 点
2,4-7,9 | 多个规则组合 | 可以看到逗号分隔的多个规则，2,4-7,9 代表 2,4,5,6,7,9

一些示例：

规则 | 含义
-- | --
\* \* \* \* \* | 每一分钟
\* 8 \* \* \* | 每天 8 点内的每一分钟
0 \*/5 \* \* \* | 每隔 5 个小时的 0 分
0 0 1 \* \* | 每个月 1 号 0 点 0 分
30 0-5 \* \* 6 | 每周六的 0 点至 5 点的 30 分
0 0 1 1 \* | 每年1月1号0点0分

## 启用计划任务

计划任务有两种运行模式，一种是基于框架运行的服务运行，只要框架的服务处于运行状态，计划任务便会随着框架自动运行。另一种是作为独立的命令执行，但要基于系统的 crontab 每分钟执行以触发计划的运行。

建议在框架有一直运行服务的情况下使用第一种，如果框架不启动服务，仅有一些命令和计划任务，则使用第二种。

### 基于框架服务运行

基于框架服务运行时，需要将 `CrontabDispatcherProcess` 进程加入到服务的进程列表中，`CrontabDispatcherProcess` 会负责计划任务的运行。

在配置文件 `config/process.php` 中加入：

```php
<?php

return [
    ...,
    Wind\Crontab\CrontabDispatcherProcess::class,
    ...
];
```

### 独立运行

将 `wind cron:run` 加入到系统的 `crontab` 配置中，该命令会执行到时需要执行的任务。

在 /etc/crontab 中或者对应用户的 crontab 配置中加入
```
* * * * *	user	php /path/to/wind cron:run
```
